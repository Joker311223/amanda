# 项目接口总结

该项目主要使用微信小程序云开发（Cloud Development）作为后端服务，通过 `wx.cloud.database()` 直接操作云数据库。所有数据库交互逻辑封装在 `utils/db-manager.js` 中。

## 接口设计规则
- **交互方式**：直接调用云数据库 SDK，非传统 HTTP 请求。
- **数据结构**：以用户 (`users` 集合) 为核心，每个用户一条记录，包含个人信息、学习进度、课程进度、作业进度等。
- **错误处理**：所有方法均包含 `try-catch` 块，错误会打印到控制台并抛出，供调用方处理。

## 接口列表

### 1. 用户初始化与检查

#### 初始化用户
- **方法名**：`initializeUser`
- **功能**：检查用户是否存在，存在则返回数据，不存在则创建新用户。
- **入参**：
  ```javascript
  {
    name: string,      // 姓名
    gender: string,    // 性别
    birthDate: string, // 出生日期
    phone: string,     // 电话
    wechat: string     // 微信号
  }
  ```
- **响应**：用户数据对象（包含 `_id` 等字段）。

#### 检查用户注册状态
- **方法名**：`checkUserRegistration`
- **功能**：根据当前用户 OpenID 检查是否已注册。
- **入参**：无
- **响应**：已注册返回用户数据对象，未注册返回 `null`。

#### 检查首次使用状态
- **方法名**：`checkIsFirstTime`
- **功能**：检查用户是否首次使用（未注册）。
- **入参**：无
- **响应**：
  ```javascript
  {
    isFirstTime: boolean, // 是否首次使用
    user: object | null   // 用户数据
  }
  ```

### 2. 用户数据操作

#### 创建新用户
- **方法名**：`createUser`
- **功能**：在 `users` 集合创建新记录。
- **入参**：同 `initializeUser`。
- **响应**：包含 `_id` 的完整用户数据对象。

#### 获取用户数据
- **方法名**：`getUser`
- **功能**：根据 `userId` 获取用户详情。
- **入参**：`userId` (String)
- **响应**：用户数据对象。

#### 从云端拉取用户数据
- **方法名**：`pullUserDataFromCloud`
- **功能**：获取用户完整数据，并格式化为前端需要的结构。
- **入参**：`userId` (String)
- **响应**：
  ```javascript
  {
    userInfo: object,
    learningProgress: object,
    courseProgress: object,
    assignmentProgress: object,
    assignmentAnswers: object
  }
  ```

### 3. 进度管理

#### 更新学习进度
- **方法名**：`updateLearningProgress`
- **功能**：更新用户的整体学习进度。
- **入参**：
  - `userId` (String)
  - `learningProgress` (Object): 包含 `currentWeek`, `completedCourses` 等。

#### 批量更新学习进度
- **方法名**：`updateBatchProgress`
- **功能**：同时更新完成的课程、作业和总经验值。
- **入参**：
  - `userId` (String)
  - `completedCourses` (Array<Number>)
  - `completedAssignments` (Array<Number>)
  - `totalExperience` (Number)

#### 更新课程进度
- **方法名**：`updateCourseProgress`
- **功能**：更新特定课程的状态。
- **入参**：
  - `userId` (String)
  - `courseId` (Number)
  - `courseData` (Object): `{ status, completedAt, notes }`

#### 更新作业进度
- **方法名**：`updateAssignmentProgress`
- **功能**：更新特定作业的状态和得分，同时保存答案。
- **入参**：
  - `userId` (String)
  - `assignmentId` (Number)
  - `assignmentData` (Object): `{ earnedPoints, answers, problems }`

#### 更新快乐分
- **方法名**：`updateHappinessScore`
- **功能**：更新用户的快乐分。
- **入参**：
  - `userId` (String)
  - `happinessScore` (Number)

### 4. 作业答案管理

#### 获取所有作业答案
- **方法名**：`getAssignmentAnswers`
- **入参**：`userId` (String)
- **响应**：所有作业的答案对象。

#### 获取特定作业答案
- **方法名**：`getAssignmentAnswer`
- **入参**：
  - `userId` (String)
  - `assignmentId` (Number)
- **响应**：特定作业的答案对象。

#### 保存答案到云端
- **方法名**：`saveAnswersToCloud`
- **功能**：仅保存答案内容。
- **入参**：
  - `userId` (String)
  - `assignmentId` (Number)
  - `answers` (Object)

### 5. 数据同步与调试

#### 同步本地数据到云端
- **方法名**：`syncLocalDataToCloud`
- **功能**：合并本地数据和云端数据（云端优先）。
- **入参**：
  - `userId` (String)
  - `localData` (Object)
- **响应**：合并后的数据对象。

#### 清空用户数据
- **方法名**：`clearUserData`
- **功能**：重置用户数据（测试用）。
- **入参**：`userId` (String)

## 变更记录

| 版本 | 日期 | 更新内容 | 维护人 |
|------|------|----------|--------|
| v1.0.0 | 2026-01-17 19:13 | 知识库文件初始化 | m-hub |
| v1.0.1 | 2026-01-17 19:15 | 常规检查与更新 | m-hub |
