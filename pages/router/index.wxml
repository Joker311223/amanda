<view class="page-container">
  <!-- 手动导引按钮 -->
  <view class="guide-trigger-btn" bindtap="showGuideManually">
    <text class="guide-icon">❓</text>
  </view>

  <!-- 经验值显示 -->
  <view class="experience-badge">
    <text class="star">⭐</text>
    <text>{{totalExperience}}分</text>
  </view>
  <!-- 学习进度条 -->
  <view class="progress-section">
    <view class="progress-container">
      <view class="progress-bar-wrapper">
        <view class="progress-bar">
          <view class="progress-fill" style="width: {{progressPercent}}%;">
            <view class="progress-indicator" style="left: 100%;">
              <view class="indicator-outer-ring">
                <view class="indicator-inner-circle"></view>
              </view>
            </view>
          </view>
        </view>
        <view class="progress-text">{{progressPercent}}%</view>
      </view>
    </view>
  </view>
  
  <view wx:key="id" wx:for="{{allCourses}}" class="page-line" style="margin-left:20rpx;padding-left: {{item.position}}; height: 100rpx;">
    <block wx:for="{{item.asssignIds}}" wx:for-item="subItem" wx:for-index="idx">
      <image style="opacity: {{ (subItem >= 0 && assignments[subItem-1].status === 'locked') ? 0.4 : 1 }};" wx:key="id" src="{{ assignments[subItem-1].status === 'locked' || assignments[subItem-1].status === 'available' ? '/images/work-icon-no.svg' : '/images/work-icon-done.svg'}}" class="item-image-mini {{assignments[subItem-1].status === 'available' ? 'available' : ''}}" data-index="{{idx}}" data-status="{{item.status}}" data-id="{{item.id}}" data-extra="{{item.otherData}}" bindtap="showAssignmentDialog" />
    </block>
    <image style="opacity: {{ (item.status === 'locked') ? 0.2 : 1 }};" src="{{item.icon}}" class="item-image {{item.status === 'available' ? 'available' : ''}}" data-id="{{item.id}}" data-title="{{item.title}}" data-status="{{item.status}}" bindtap="showCourseDialog" />
  </view>

  <!-- 确认弹窗 -->
  <view class="dialog-mask" wx:if="{{showDialog}}" bindtap="hideDialog" catchtouchmove="preventTouchMove">
    <view class="dialog-container" catchtap="stopPropagation">
      <!-- 顶部装饰三角形 -->
      <view class="dialog-triangle"></view>

      <!-- 弹窗内容 -->
      <view class="dialog-content">
        <!-- 图标 -->
        <view class="dialog-icon">
          <image wx:if="{{dialogData.iconUrl}}" src="{{dialogData.iconUrl}}" class="dialog-icon-image" mode="aspectFit" />
          <text wx:else class="dialog-emoji">{{dialogData.emoji}}</text>
        </view>

        <!-- 标题 -->
        <view class="dialog-title">{{dialogData.title}}</view>

        <!-- 描述 -->
        <view class="dialog-desc">{{dialogData.desc}}</view>

        <!-- 额外信息 -->
        <view class="dialog-info" wx:if="{{dialogData.info}}">
          <text class="info-icon">ℹ️</text>
          <text class="info-text">{{dialogData.info}}</text>
        </view>

        <!-- 按钮 -->
        <view class="dialog-buttons {{dialogData.showCancel === false ? 'single-button' : ''}}">
          <view class="dialog-btn dialog-btn-cancel" wx:if="{{dialogData.showCancel !== false}}" bindtap="hideDialog">
            <text>取消</text>
          </view>
          <view class="dialog-btn dialog-btn-confirm" bindtap="confirmDialog">
            <text>{{dialogData.confirmText}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 新手导引组件 -->
  <guide
    show="{{showGuide}}"
    steps="{{guideSteps}}"
    bind:complete="onGuideComplete"
    bind:stepchange="onGuideStepChange"
  />

  <!-- Debug按钮 -->
  <view wx:if="{{showDebugButtons}}" class="debug-buttons">
    <button class="debug-btn debug-btn-clear" bindtap="debugClearAllProgress">
      🗑️ 清空记录
    </button>
    <button class="debug-btn debug-btn-complete" bindtap="debugCompleteAllCourses">
      ✅ 完成全部
    </button>
  </view>

  <!-- 完成所有课程弹窗 -->
  <view class="completion-modal-mask" wx:if="{{showCompletionModal}}" catchtouchmove="preventTouchMove">
    <view class="completion-modal">
      <!-- 顶部装饰图 -->
      <view class="completion-header">
        <view class="completion-emoji-group">
          <text class="completion-emoji">🎉</text>
          <text class="completion-emoji">🎊</text>
          <text class="completion-emoji">✨</text>
        </view>
      </view>

      <!-- 内容区域 -->
      <view class="completion-content">
        <view class="completion-title">恭喜通关！</view>

        <view class="completion-desc">
          <text>太棒啦！你已完成DBT情绪技能所有课程，成功 get 全套情绪管理工具。</text>
        </view>

        <view class="completion-points">
          <text class="points-label">本次成长累计获得</text>
          <text class="points-value">{{totalEarnedExperience}}</text>
          <text class="points-unit">分快乐经验</text>
        </view>

        <view class="completion-message">
          <text>每一分都是你用心练习的见证！</text>
          <text>情绪成长没有终点，带着这些技能继续出发吧，你会成为更从容的自己！</text>
        </view>

        <view class="completion-contact">
          <text>请通关小朋友联系负责人杨老师</text>
          <text class="wechat-id" bindtap="copyWechat">18888929709 (wechat)</text>
          <text>获取更多学习资源！</text>
        </view>
      </view>

      <!-- 关闭按钮 -->
      <view class="completion-close-btn" bindtap="closeCompletionModal">
        <text>我知道了</text>
      </view>
    </view>
  </view>

</view>